include:
  - project: "wog/gvt/wogaa/projects/git-lab-templates"
    ref: main
    file:
      - "jobs/common/trigger-rules.yml"
      - "jobs/common/nexus-iq-scan.yml"
      - "vars/.gitlab-cdk-vars.yml"

stages: 
  - prune-remote
  - update-remote

workflow:
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_DEFAULT_BRANCH == $CI_COMMIT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "web"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

image: registry.sgts.gitlab-dedicated.com/wog/gvt/wogaa/projects/cicd-images/alpine-3.19-node-20:v1.0.2

cache:
  paths:
    - "wogaa-tracker-cordova-plugin"


nexus-iq-scan-job:
  extends:
    - .nexus-iq-scan-npm
  before_script:
    - echo "File Generation"
    - |
      export JS_FILE="merge.js"

      # Generate a JavaScript file
      cat <<EOL > $JS_FILE
      const fs = require("fs");

      // Define the input package.json files
      const packageFiles = ["./package.json"];
      const outputFile = "package.json";

      // Function to merge two JSON objects (handling dependencies)
      function mergeObjects(target, source) {
          for (const key in source) {
              if (typeof source[key] === "object" && !Array.isArray(source[key])) {
                  target[key] = mergeObjects(target[key] || {}, source[key]);
              } else {
                  target[key] = source[key]; // Overwrites existing fields
              }
          }
          return target;
      }

      // Read and merge package.json files
      let mergedPackage = {};
      packageFiles.forEach((file) => {
          if (fs.existsSync(file)) {
              const packageData = JSON.parse(fs.readFileSync(file, "utf8"));
              mergedPackage = mergeObjects(mergedPackage, packageData);
          } else {
              console.warn(`Warning: ${file} not found.`);
          }
      });

      // Write the merged output
      fs.writeFileSync(outputFile, JSON.stringify(mergedPackage, null, 2));
      console.log(`Merged package.json written to ${outputFile}`);
      EOL

      echo "JavaScript file '$JS_FILE' generated successfully."

      # Run the generated JavaScript file using Node.js
      node $JS_FILE
    - echo "Nexus Generation Complete"
    - ls -lah
    - cat package.json
    - npm install --production
  variables:
    NEXUS_IQ_PROJECT_ID: "wogaa-cordova-tracker"


# set-github-origin:
#   stage: prune-remote
#   before_script:
#     - rm -rf .git
#   script:
#     - git config --global user.email "wogaa@tech.gov.sg"
#     - git config --global user.name "WOGAA gitlab CICD"
#     - git clone https://github.com/wogaa/wogaa-tracker-cordova-plugin.git

# update-remote:
#   stage: update-remote
#   needs: 
#     - set-github-origin
#   script:
#     - ls -al
#     - cp -r  * ./wogaa-tracker-cordova-plugin
#     - cd wogaa-tracker-cordova-plugin
#     - sh ../update-github-remote.sh
#   when: manual

